<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comandos - {{ pdv.label }}</title>
    <style>
        :root {
            --bg-color: #2c3e50; /* Azul escuro principal */
            --card-bg-color: #34495e; /* Azul acinzentado para cards/headers */
            --text-color: #ecf0f1; /* Branco suave para texto */
            --primary-blue: #3498db; /* Azul vibrante */
            --green-success: #2ecc71; /* Verde para sucesso */
            --red-error: #e74c3c; /* Vermelho para erro */
            --gray-disabled: #7f8c8d; /* Cinza para desabilitado */
            --shadow-light: rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 25px; /* Aumentei um pouco o padding para melhor espa√ßamento */
            transition: opacity 0.3s ease-out; /* Transi√ß√£o de opacidade para a p√°gina inteira */
            min-height: 100vh; /* Garante que o body ocupa a altura total */
            box-sizing: border-box; /* Inclui padding na altura */
        }

        /* Anima√ß√£o de sa√≠da da p√°gina */
        body.fade-out-page {
            opacity: 0;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-bg-color);
            padding: 20px; /* Aumentei o padding */
            border-radius: 10px; /* Borda mais arredondada */
            margin-bottom: 25px; /* Mais espa√ßo */
            box-shadow: 0 5px 15px var(--shadow-light); /* Sombra para profundidade */
        }
        .header h1 {
            margin: 0;
            font-size: 1.8em; /* Tamanho maior para o t√≠tulo */
            color: white; /* Garante que o t√≠tulo √© branco */
        }
        .btn-copy {
            background-color: var(--primary-blue); /* Cor principal para o bot√£o de copiar */
            color: white;
            border: none;
            padding: 12px 20px; /* Padding ajustado */
            border-radius: 25px; /* Mais arredondado (pill shape) */
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 8px var(--shadow-light);
        }
        .btn-copy:hover {
            background-color: #49a7e0; /* Tom mais claro no hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .btn-copy:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px var(--shadow-light);
        }
        .actions {
            display: flex;
            flex-direction: column;
            gap: 18px; /* Espa√ßamento entre os bot√µes */
        }
        .btn {
            padding: 20px;
            border: none;
            border-radius: 10px; /* Bordas arredondadas */
            font-size: 1.2em; /* Tamanho da fonte maior */
            font-weight: bold;
            color: white;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 12px var(--shadow-light);
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px var(--shadow-light);
        }
        .btn:disabled, .btn-copy:disabled {
            background-color: var(--gray-disabled) !important; /* !important para garantir que sobreponha */
            cursor: not-allowed;
            opacity: 0.7;
            transform: translateY(0) !important; /* Desabilita o transform no disabled */
            box-shadow: none !important; /* Remove sombra no disabled */
        }
        .btn-restart-app { background-color: var(--primary-blue); }
        .btn-restart-app:hover { background-color: #49a7e0; } /* Tom mais claro */

        .btn-restart-machine { background-color: #27AE60; } /* Laranja */
        .btn-restart-machine:hover { background-color: #3faa4d; } /* Laranja mais claro */

        .btn-shutdown { background-color: var(--red-error); } /* Vermelho */
        .btn-shutdown:hover { background-color: #c0392b; } /* Vermelho mais escuro */

        #message-area {
            position: fixed;
            bottom: 25px; /* Ajustei a posi√ß√£o */
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            padding: 15px 25px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            font-weight: 500;
        }
        a.back-link {
            color: var(--primary-blue);
            text-decoration: none;
            display: inline-block;
            margin-bottom: 25px; /* Mais espa√ßo */
            font-weight: bold;
            font-size: 1.1em;
            transition: color 0.2s ease, transform 0.1s ease;
        }
        a.back-link:hover {
            color: #49a7e0;
            transform: translateX(-5px); /* Efeito de deslizar um pouco para tr√°s */
        }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* Fundo mais escuro */
            display: none;
            flex-direction: column;
            justify-content: center; align-items: center; z-index: 2000;
            color: white; font-size: 1.6em; /* Fonte maior */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5); /* Sombra no texto */
        }
        .spinner {
            border: 8px solid rgba(255, 255, 255, 0.3); /* Cor do spinner mais suave */
            border-top: 8px solid var(--primary-blue); /* Cor vibrante */
            border-radius: 50%; width: 70px; height: 70px; /* Tamanho maior */
            animation: spin 1s linear infinite; margin-bottom: 25px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        p {
            font-size: 1.1em;
            margin-top: 30px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Media queries para responsividade */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
            }
            .header h1 {
                margin-bottom: 10px;
                font-size: 1.6em;
            }
            .btn-copy {
                width: 100%; /* Bot√£o de c√≥pia ocupa largura total em mobile */
                box-sizing: border-box;
                padding: 10px 15px;
            }
            .actions {
                gap: 12px;
            }
            .btn {
                font-size: 1em;
                padding: 18px;
            }
            #message-area {
                width: 90%;
                left: 5%;
                transform: translateX(0);
                bottom: 15px;
                box-sizing: border-box;
            }
            .spinner {
                width: 50px;
                height: 50px;
                border-width: 6px;
            }
            #loading-overlay span {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <span>Aguarde, enviando comando...</span>
    </div>

    <a href="/" class="back-link" id="back-to-grid-link">&larr; Voltar para a Grade</a>

    <div class="header">
        <h1>{{ pdv.label }}</h1>
        <button class="btn-copy" data-senha="{{ pdv.senha }}" onclick="copiarSenha(this)">Copiar Senha üîë</button>
    </div>

    {% if pdv.online %}
    <div class="actions">
        <button class="btn btn-restart-app" onclick="enviarComando('{{ pdv.ip }}', 'reiniciar_app')">üåÄ Reiniciar App Gr√°fico</button>
        <button class="btn btn-restart-machine" onclick="enviarComando('{{ pdv.ip }}', 'reiniciar_maquina')">üîÑ Reiniciar M√°quina</button>
        <button class="btn btn-shutdown" onclick="enviarComando('{{ pdv.ip }}', 'desligar_maquina')">üõë Desligar M√°quina</button>
    </div>
    {% else %}
    <p>Este PDV est√° offline. N√£o √© poss√≠vel enviar comandos.</p>
    {% endif %}

    <div id="message-area"></div>

    <script>
        // Transi√ß√£o de p√°gina: define o tempo da anima√ß√£o de sa√≠da antes do redirecionamento
        const PAGE_TRANSITION_DURATION = 300; // milissegundos

        function showMessage(text, isError = false) {
            const messageArea = document.getElementById('message-area');
            messageArea.textContent = text;
            messageArea.style.backgroundColor = isError ? 'var(--red-error)' : 'var(--green-success)';
            messageArea.style.color = 'white';
            messageArea.style.display = 'block';
            setTimeout(() => { messageArea.style.display = 'none'; }, 4000);
        }

        async function copiarSenha(buttonElement) {
            const senha = buttonElement.dataset.senha;
            const originalText = buttonElement.innerHTML;
            // Usar getComputedStyle para pegar a cor de fundo real, caso ela mude via CSS
            const originalBackgroundColor = window.getComputedStyle(buttonElement).backgroundColor;

            const darFeedbackSucesso = () => {
                buttonElement.innerHTML = 'Copiado! ‚úì';
                buttonElement.style.backgroundColor = 'var(--green-success)';
                buttonElement.disabled = true; // Desabilita durante o feedback
                setTimeout(() => {
                    buttonElement.innerHTML = originalText;
                    buttonElement.style.backgroundColor = originalBackgroundColor;
                    buttonElement.disabled = false; // Reabilita
                }, 2000);
            };

            const darFeedbackErro = () => showMessage('Falha ao copiar a senha.', true);
            
            if (navigator.clipboard && window.isSecureContext) {
                try {
                    await navigator.clipboard.writeText(senha);
                    darFeedbackSucesso();
                    return; // Sai da fun√ß√£o ap√≥s sucesso com a API moderna
                } catch (err) {
                    console.error('Falha na API Clipboard: ', err);
                }
            }
            
            // Fallback para navegadores sem a API Clipboard ou em contextos n√£o seguros
            const textArea = document.createElement("textarea");
            textArea.value = senha;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px"; // Fora da tela
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy') ? darFeedbackSucesso() : darFeedbackErro();
            } catch (err) {
                darFeedbackErro();
                console.error('Falha no execCommand: ', err);
            } finally {
                document.body.removeChild(textArea);
            }
        }

        async function enviarComando(ip, acao) {
            const acaoFormatada = acao.replace(/_/g, ' ');
            if (!confirm(`Tem certeza que deseja ${acaoFormatada}?`)) return;
            
            document.getElementById('loading-overlay').style.display = 'flex';
            
            const allButtons = document.querySelectorAll('.btn, .btn-copy');
            allButtons.forEach(btn => btn.disabled = true);

            try {
                const response = await fetch(`/comando/individual/${ip}/${acao}`, { method: 'POST' });
                const data = await response.json(); 
                showMessage(data.mensagem, !data.sucesso);
            } catch (error) {
                console.error('Fetch error:', error);
                showMessage('Erro de conex√£o com o servidor. Verifique o console (F12).', true);
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
                
                // Reabilita os bot√µes ap√≥s um pequeno intervalo para evitar cliques acidentais.
                setTimeout(() => {
                    allButtons.forEach(btn => btn.disabled = false);
                }, 500);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const backLink = document.getElementById('back-to-grid-link');
            
            if (backLink) {
                backLink.addEventListener('click', function(event) {
                    event.preventDefault(); // Impede o comportamento padr√£o do link
                    
                    // Adiciona a classe de fade-out ao body
                    document.body.classList.add('fade-out-page');
                    
                    // Redireciona ap√≥s a dura√ß√£o da anima√ß√£o
                    setTimeout(() => {
                        window.location.href = backLink.href;
                    }, PAGE_TRANSITION_DURATION);
                });
            }
        });
    </script>
</body>
</html>